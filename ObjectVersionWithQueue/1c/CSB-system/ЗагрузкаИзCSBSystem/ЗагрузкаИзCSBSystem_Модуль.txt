Перем КаталогВыгрузкиКонтрагентов, КаталогВыгрузкиНоменклатуры, КаталогВыгрузкиПоступления;

Функция ПолучитьСрокХраненияТолькоЦифры(НоменклатураСсылка)
	
	Результат = "";
	
	Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("00000000011");
	
	НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Объект.Установить(НоменклатураСсылка, Истина);
	НаборЗаписей.Отбор.Свойство.Установить(Свойство, Истина);
	
	НаборЗаписей.Прочитать();
	
	Если НЕ НаборЗаписей.Количество() = 0 Тогда
		
		Результат = СокрЛП(НаборЗаписей[0].Значение);
		//Значение = СокрЛП(НаборЗаписей[0].Значение);
		
		//Для Сч = 1 По СтрДлина(Значение) Цикл
		//	
		//	Если НЕ Найти("0123456789", Сред(Значение, Сч, 1)) = 0 Тогда
		//	
		//		Результат = Результат + Сред(Значение, Сч, 1);
		//		
		//	Иначе
		//		Прервать;
		//	КонецЕсли;
		//	
		//КонецЦикла;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ВыгрузитьЭлементСправочника(текЗначение, ЗаписьXML)
	
	Если ТипЗнч(текЗначение) = Тип("СправочникСсылка.Номенклатура") Тогда
		//Наименование 1
		Если ЗначениеЗаполнено(текЗначение.Наименование) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name1");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Наименование 2
		Если ЗначениеЗаполнено(текЗначение.НаименованиеПолное) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name2");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.НаименованиеПолное));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Наименование 5
		ЗаписьXML.ЗаписатьНачалоЭлемента("Name5");
		ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.УникальныйИдентификатор()));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		//Группа Артикул
		Если ЗначениеЗаполнено(текЗначение.Родитель) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Group1");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Родитель));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Ценовая единица измерения
		Если ЗначениеЗаполнено(текЗначение.ЕдиницаХраненияОстатков) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("PU");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ЕдиницаХраненияОстатков));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Вес ценовой единицы
		Если ЗначениеЗаполнено(текЗначение.ЕдиницаХраненияОстатков.Вес) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("FactorPU");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ЕдиницаХраненияОстатков.Вес));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Единица Заказа измерения
		Если ЗначениеЗаполнено(текЗначение.ЕдиницаХраненияОстатков) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("IU");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ЕдиницаХраненияОстатков));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Вес Единица Заказа
		Если ЗначениеЗаполнено(текЗначение.ЕдиницаХраненияОстатков.Вес) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("FactorIU");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ЕдиницаХраненияОстатков.Вес));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Срок хранения
		СрокХранения = ПолучитьСрокХраненияТолькоЦифры(текЗначение);
		Если ЗначениеЗаполнено(СрокХранения) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("ShelfLife1");
			ЗаписьXML.ЗаписатьТекст(СрокХранения);
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(текЗначение) = Тип("СправочникСсылка.Контрагенты") Тогда
		
		//Номер 1С
		Если ЗначениеЗаполнено(текЗначение.Код) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("AdressID");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Код));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Иском. Панятие
		Если ЗначениеЗаполнено(текЗначение.Наименование) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name1");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Название 1
		Если ЗначениеЗаполнено(текЗначение.НаименованиеПолное) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name2");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.НаименованиеПолное));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Название 5 Номер 1С
		ЗаписьXML.ЗаписатьНачалоЭлемента("Name5");
		ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.УникальныйИдентификатор()));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		//ИНН
		Если ЗначениеЗаполнено(текЗначение.ИНН) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("INN");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ИНН));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//КПП
		Если ЗначениеЗаполнено(текЗначение.КПП) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("KPP");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.КПП));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ВыгрузитьЭлементыСправочника(МассивЭлементов, КаталогВыгрузки)
	
	ЗаписьXML = Новый ЗаписьXML;
		
	ЗаписьXML.ОткрытьФайл(КаталогВыгрузки + "from1c.xml", "windows-1251");
		
	ЗаписьXML.ЗаписатьОбъявлениеXML();    
	ЗаписьXML.ЗаписатьНачалоЭлемента("Item");
	
	Если НЕ ТипЗнч(МассивЭлементов) = Тип("Массив") Тогда
		ЗаписьXML.ЗаписатьНачалоЭлемента("Table");
		ЗаписьXML.ЗаписатьНачалоЭлемента("Row");
		ВыгрузитьЭлементСправочника(МассивЭлементов, ЗаписьXML);
		ЗаписьXML.ЗаписатьКонецЭлемента();
		ЗаписьXML.ЗаписатьКонецЭлемента();
	Иначе
		
		Для Каждого текЗначение Из МассивЭлементов Цикл
			ЗаписьXML.ЗаписатьНачалоЭлемента("Table");
			ЗаписьXML.ЗаписатьНачалоЭлемента("Row");
			ВыгрузитьЭлементСправочника(текЗначение, ЗаписьXML);
			ЗаписьXML.ЗаписатьКонецЭлемента();
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЦикла;
		
	КонецЕсли;
	
	ЗаписьXML.ЗаписатьКонецЭлемента();
		
	ЗаписьXML.Закрыть();		
	
КонецПроцедуры

Процедура ВыгрузитьДокумент(Объект)
	
	ЗаписьXML = Новый ЗаписьXML;
	
	ЗаписьXML.ОткрытьФайл(КаталогВыгрузкиПоступления + "from1c_" + СокрЛП(Объект.Ссылка.УникальныйИдентификатор()) + ".xml", "windows-1251");
	
	ЗаписьXML.ЗаписатьОбъявлениеXML();    
	ЗаписьXML.ЗаписатьНачалоЭлемента("Customers");
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("CustomerID");
	ЗаписьXML.ЗаписатьТекст(СокрЛП(Объект.Ссылка.Номер));
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("USERID");
	ЗаписьXML.ЗаписатьТекст(СокрЛП(Объект.Ссылка.УникальныйИдентификатор()));
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("OrderDate");
	ЗаписьXML.ЗаписатьТекст(Формат(Объект.Ссылка.Дата, "ДФ=ггггММдд"));
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	Для Каждого текТовар Из Объект.Ссылка.Товары Цикл
		ЗаписьXML.ЗаписатьНачалоЭлемента("Row");
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("ItemID");
		ЗаписьXML.ЗаписатьТекст(СокрЛП(текТовар.Номенклатура.УникальныйИдентификатор()));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Quantity");
		ЗаписьXML.ЗаписатьТекст(Формат(текТовар.Количество, "ЧЦ=15; ЧДЦ=3; ЧГ=0"));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Price");
		ЗаписьXML.ЗаписатьТекст(Формат(текТовар.Цена, "ЧЦ=15; ЧДЦ=2; ЧГ=0"));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		
		ЗаписьXML.ЗаписатьКонецЭлемента();
	КонецЦикла;
	
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	ЗаписьXML.Закрыть();
	
КонецПроцедуры

Процедура ЗагрузитьДокумент(Объект)
	
	
	//Файл = Новый Файл(КаталогВыгрузкиПоступления + "to1c_" + СокрЛП(Объект.Ссылка.УникальныйИдентификатор()) + ".xml");
	Файл = Новый Файл(КаталогВыгрузкиПоступления + СокрЛП(Объект.Ссылка.УникальныйИдентификатор()) + ".xml");
	Если НЕ Файл.Существует() Тогда
		Предупреждение("Данные из CSB-system не выгружены! Загрузка невозможна!");
		Возврат;
	КонецЕсли;
	
	ТаблицаЗначений = Новый ТаблицаЗначений;
	ТаблицаЗначений.Колонки.Добавить("Номенклатура");
	ТаблицаЗначений.Колонки.Добавить("Количество");
	
	ЧтениеXML = Новый ЧтениеXML;
	
	//ЧтениеXML.ОткрытьФайл(КаталогВыгрузкиПоступления + "to1c_" + СокрЛП(Объект.Ссылка.УникальныйИдентификатор()) + ".xml", , , "windows-1251");
	ЧтениеXML.ОткрытьФайл(КаталогВыгрузкиПоступления + СокрЛП(Объект.Ссылка.УникальныйИдентификатор()) + ".xml", , , "windows-1251");
	
	Если ЧтениеXML.Прочитать() Тогда
		
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.Имя = "Row" Тогда
				
				Номенклатура = Справочники.Номенклатура.ПустаяСсылка();
				Количество = 0;
				
				Пока ЧтениеXML.Прочитать() Цикл
					Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.Имя = "ItemID" Тогда
						Если ЧтениеXML.Прочитать() Тогда
							//Сообщить(СокрЛП(ЧтениеXML.Значение));
							Номенклатура = Справочники.Номенклатура.ПолучитьСсылку(Новый УникальныйИдентификатор(СокрЛП(ЧтениеXML.Значение)));
						КонецЕсли;
					КонецЕсли;
					
					Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.Имя = "Quantity" Тогда
						Если ЧтениеXML.Прочитать() Тогда
							//Сообщить(СокрЛП(ЧтениеXML.Значение));
							Попытка
								Количество = Число(ЧтениеXML.Значение);
							Исключение
							КонецПопытки;
							Прервать;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
				
				//НайденнаяСтрока = Объект.Товары.Найти(Номенклатура, "Номенклатура");
				//Если НЕ НайденнаяСтрока = Неопределено Тогда
				//	НайденнаяСтрока.Количество = Количество;
				//КонецЕсли;
				новСтрока = ТаблицаЗначений.Добавить();
				новСтрока.Номенклатура = Номенклатура;
				новСтрока.Количество = Количество;
				//брать сумму с ндс делить на старое кол-во умножать на новое
				
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	Если НЕ ТаблицаЗначений.Количество() = 0 Тогда
		
		Для Сч = 1 По ТаблицаЗначений.Количество() Цикл
			
			Объект.Товары[Сч-1].Количество = ТаблицаЗначений[Сч-1].Количество;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура Инициализировать(Объект, ИмяТабличнойЧасти, ТабличноеПоле) Экспорт
	
	Если Объект.ЭтоНовый() Тогда
		Предупреждение("Нельзя загрузить незаписанный документ!");
		Возврат;
	КонецЕсли;
	
	ЗагрузитьДокумент(Объект);
	
КонецПроцедуры

КаталогВыгрузкиКонтрагентов	= "\\csb1\CSB\EDI\import\10\";//"D:\1c\CSB_System\Adress\";
КаталогВыгрузкиНоменклатуры	= "\\csb1\CSB\EDI\import\12\";//"D:\1c\CSB_System\Artikul\";
КаталогВыгрузкиПоступления	= "\\csb1\CSB\EDI\export\2123\";//temp\";//"\\192.168.0.81\csb\v521\vladimirskij\import\2123\";//"D:\1c\CSB_System\Priemka\";