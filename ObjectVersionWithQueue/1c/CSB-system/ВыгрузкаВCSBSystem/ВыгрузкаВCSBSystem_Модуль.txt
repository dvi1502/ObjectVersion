Перем КаталогВыгрузкиКонтрагентов, КаталогВыгрузкиНоменклатуры, КаталогВыгрузкиПоступления;

//+malkov #49
Перем КаталогВыгрузкиИзготовителей;
///malkov

Функция ПолучитьСрокХраненияТолькоЦифры(НоменклатураСсылка)
	
	Результат = "";
	
	Свойство = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("00000000011");
	
	НаборЗаписей = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Объект.Установить(НоменклатураСсылка, Истина);
	НаборЗаписей.Отбор.Свойство.Установить(Свойство, Истина);
	
	НаборЗаписей.Прочитать();
	
	Если НЕ НаборЗаписей.Количество() = 0 Тогда
		
		Значение = СокрЛП(НаборЗаписей[0].Значение);
		
		Для Сч = 1 По СтрДлина(Значение) Цикл
			
			Если НЕ Найти("0123456789", Сред(Значение, Сч, 1)) = 0 Тогда
			
				Результат = Результат + Сред(Значение, Сч, 1);
				
			Иначе
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
		Попытка
			Результат = Число(?(ПустаяСтрока(Результат), "0", Результат));
		Исключение
			Сообщить(ОписаниеОшибки());
			Возврат 0;
		КонецПопытки;
		
		Если Найти(НРег(Значение), "ч") > 0 Тогда
			Результат = Результат / 24;
		КонецЕсли;
		
	Иначе
		Результат = 0;
	КонецЕсли;
	
	Возврат Формат(Результат, "ЧЦ=15; ЧДЦ=1; ЧН=0; ЧГ=0");
	
КонецФункции

Процедура ВыгрузитьЭлементСправочника(текЗначение)
	
	Если ТипЗнч(текЗначение) = Тип("СправочникСсылка.Номенклатура") Тогда
		КаталогВыгрузки = КаталогВыгрузкиНоменклатуры;
		
	//+malkov #49
	ИначеЕсли ТипЗнч(текЗначение) = Тип("СправочникСсылка.ИзготовительСырья") Тогда 
		КаталогВыгрузки = КаталогВыгрузкиИзготовителей;
	///malkov
	
	Иначе
		КаталогВыгрузки = КаталогВыгрузкиКонтрагентов;
	КонецЕсли;

	ЗаписьXML = Новый ЗаписьXML;
		
	ЗаписьXML.ОткрытьФайл(КаталогВыгрузки + "from1c_" + СокрЛП(текЗначение.УникальныйИдентификатор()) + ".xml", "windows-1251");
		
	ЗаписьXML.ЗаписатьОбъявлениеXML();    
	ЗаписьXML.ЗаписатьНачалоЭлемента("Item");
	ЗаписьXML.ЗаписатьНачалоЭлемента("Table");
	ЗаписьXML.ЗаписатьНачалоЭлемента("Row");
		
	Если ТипЗнч(текЗначение) = Тип("СправочникСсылка.Номенклатура") Тогда
		//Наименование 1
		Если ЗначениеЗаполнено(текЗначение.Наименование) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name1");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Наименование 2
		Если ЗначениеЗаполнено(текЗначение.НаименованиеПолное) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name2");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.НаименованиеПолное));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Наименование 5
		ЗаписьXML.ЗаписатьНачалоЭлемента("Name4");
		ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.УникальныйИдентификатор()));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		ЗаписьXML.ЗаписатьНачалоЭлемента("Name5");
		ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Код));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		//Группа Артикул
		Если ЗначениеЗаполнено(текЗначение.Родитель) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("group1");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Родитель));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Ценовая единица измерения
		Если ЗначениеЗаполнено(текЗначение.ЕдиницаХраненияОстатков) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("PU");
			//килограммы большими буквами
			Если СокрЛП(текЗначение.ЕдиницаХраненияОстатков.ЕдиницаПоКлассификатору.Код) = "166" Тогда
				ЗаписьXML.ЗаписатьТекст("КГ");
			Иначе
				ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ЕдиницаХраненияОстатков));
			КонецЕсли;
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Вес ценовой единицы
		Если ЗначениеЗаполнено(текЗначение.ЕдиницаХраненияОстатков.Вес) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("FactorPU");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ЕдиницаХраненияОстатков.Вес));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Единица Заказа измерения
		Если ЗначениеЗаполнено(текЗначение.ЕдиницаХраненияОстатков) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("IU");
			//килограммы большими буквами
			Если СокрЛП(текЗначение.ЕдиницаХраненияОстатков.ЕдиницаПоКлассификатору.Код) = "166" Тогда
				ЗаписьXML.ЗаписатьТекст("КГ");
			Иначе
				ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ЕдиницаХраненияОстатков));
			КонецЕсли;
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Вес Единица Заказа
		Если ЗначениеЗаполнено(текЗначение.ЕдиницаХраненияОстатков.Вес) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("FactorIU");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ЕдиницаХраненияОстатков.Вес));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Срок хранения
		СрокХранения = ПолучитьСрокХраненияТолькоЦифры(текЗначение);
		ЗаписьXML.ЗаписатьНачалоЭлемента("ShelfLife1");
		ЗаписьXML.ЗаписатьТекст(СрокХранения);
		ЗаписьXML.ЗаписатьКонецЭлемента();
		
	ИначеЕсли ТипЗнч(текЗначение) = Тип("СправочникСсылка.Контрагенты") Тогда
		
		//Номер 1С
		Если ЗначениеЗаполнено(текЗначение.Код) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("AdressID");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Код));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Иском. Панятие
		Если ЗначениеЗаполнено(текЗначение.Наименование) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name1");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Название 1
		Если ЗначениеЗаполнено(текЗначение.НаименованиеПолное) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name2");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.НаименованиеПолное));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//Название 5 Номер 1С
		ЗаписьXML.ЗаписатьНачалоЭлемента("Name3");
		ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.УникальныйИдентификатор()));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		//ИНН
		Если ЗначениеЗаполнено(текЗначение.ИНН) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("INN");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.ИНН));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		//КПП
		Если ЗначениеЗаполнено(текЗначение.КПП) Тогда
			ЗаписьXML.ЗаписатьНачалоЭлемента("KPP");
			ЗаписьXML.ЗаписатьТекст(?(ПустаяСтрока(текЗначение.КПП), "000000000", СокрЛП(текЗначение.КПП)));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		
	//+malkov #49
	ИначеЕсли ТипЗнч(текЗначение) = Тип("СправочникСсылка.ИзготовительСырья")
		И ЗначениеЗаполнено(текЗначение) Тогда
		
		РеквизитыСправочника = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(текЗначение, "Код, Наименование");

		Если ЗначениеЗаполнено(РеквизитыСправочника.Код) Тогда 
			ЗаписьXML.ЗаписатьНачалоЭлемента("AdressID");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Код));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		
		Если ЗначениеЗаполнено(РеквизитыСправочника.Наименование) Тогда 
			ЗаписьXML.ЗаписатьНачалоЭлемента("Name2");
			ЗаписьXML.ЗаписатьТекст(СокрЛП(текЗначение.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		///malkov
		
	КонецЕсли;
	
	ЗаписьXML.ЗаписатьКонецЭлемента();
	ЗаписьXML.ЗаписатьКонецЭлемента();
	ЗаписьXML.ЗаписатьКонецЭлемента();
		
	ЗаписьXML.Закрыть();
	
КонецПроцедуры

Процедура ВыгрузитьЭлементыСправочника(МассивЭлементов, КаталогВыгрузки)
	
	//ЗаписьXML = Новый ЗаписьXML;
	//	
	//ЗаписьXML.ОткрытьФайл(КаталогВыгрузки + "from1c.xml", "windows-1251");
	//	
	//ЗаписьXML.ЗаписатьОбъявлениеXML();    
	//ЗаписьXML.ЗаписатьНачалоЭлемента("Item");
	
	Если НЕ ТипЗнч(МассивЭлементов) = Тип("Массив") Тогда
		//ЗаписьXML.ЗаписатьНачалоЭлемента("Table");
		//ЗаписьXML.ЗаписатьНачалоЭлемента("Row");
		ВыгрузитьЭлементСправочника(МассивЭлементов);
		//ЗаписьXML.ЗаписатьКонецЭлемента();
		//ЗаписьXML.ЗаписатьКонецЭлемента();
	Иначе
		
		Для Каждого текЗначение Из МассивЭлементов Цикл
			//ЗаписьXML.ЗаписатьНачалоЭлемента("Table");
			//ЗаписьXML.ЗаписатьНачалоЭлемента("Row");
			ВыгрузитьЭлементСправочника(текЗначение);
			//ЗаписьXML.ЗаписатьКонецЭлемента();
			//ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЦикла;
		
	КонецЕсли;
	
	//ЗаписьXML.ЗаписатьКонецЭлемента();
	//	
	//ЗаписьXML.Закрыть();		
	
КонецПроцедуры

Процедура ВыгрузитьДокумент(Объект)
	
	ЗаписьXML = Новый ЗаписьXML;
	
	ЗаписьXML.ОткрытьФайл(КаталогВыгрузкиПоступления + "from1c_" + СокрЛП(Объект.Ссылка.УникальныйИдентификатор()) + ".xml", "windows-1251");
	
	ЗаписьXML.ЗаписатьОбъявлениеXML();    
	ЗаписьXML.ЗаписатьНачалоЭлемента("Customers");
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("CustomerID");
	ЗаписьXML.ЗаписатьТекст(СокрЛП(Объект.Ссылка.Номер));
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("USERID");
	ЗаписьXML.ЗаписатьТекст(СокрЛП(Объект.Ссылка.УникальныйИдентификатор()));
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("AdressID");
	ЗаписьXML.ЗаписатьТекст(СокрЛП(Объект.Контрагент.УникальныйИдентификатор()));
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("OrderDate");
	ЗаписьXML.ЗаписатьТекст(Формат(Объект.Ссылка.Дата, "ДФ=ггггММдд"));
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	Для Каждого текТовар Из Объект.Ссылка.Товары Цикл
		ЗаписьXML.ЗаписатьНачалоЭлемента("Row");
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("ItemID");
		ЗаписьXML.ЗаписатьТекст(СокрЛП(текТовар.Номенклатура.УникальныйИдентификатор()));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Quantity");
		ЗаписьXML.ЗаписатьТекст(Формат(текТовар.Количество, "ЧЦ=15; ЧДЦ=3; ЧГ=0"));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Price");
		ЗаписьXML.ЗаписатьТекст(Формат(текТовар.Цена, "ЧЦ=15; ЧДЦ=2; ЧГ=0"));
		ЗаписьXML.ЗаписатьКонецЭлемента();
		
		//+malkov #49
		Если ЗначениеЗаполнено(текТовар.Изготовитель) Тогда 
			ЗаписьXML.ЗаписатьНачалоЭлемента("ManufacturerID");
			ЗаписьXML.ЗаписатьТекст("" + текТовар.Изготовитель.УникальныйИдентификатор());
			ЗаписьXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
		///malkov
		
		ЗаписьXML.ЗаписатьКонецЭлемента();
	КонецЦикла;
	
	ЗаписьXML.ЗаписатьКонецЭлемента();
	
	ЗаписьXML.Закрыть();
	
КонецПроцедуры

Процедура Инициализировать(Объект, ИмяТабличнойЧасти, ТабличноеПоле) Экспорт
	
	Если Объект.ЭтоНовый() Тогда
		Предупреждение("Нельзя выгрузить незаписанный документ!");
		Возврат;
	КонецЕсли;
	
	ВыгрузитьЭлементыСправочника(Объект.Контрагент, КаталогВыгрузкиКонтрагентов);
	ВыгрузитьЭлементыСправочника(Объект.Товары.ВыгрузитьКолонку("Номенклатура"), КаталогВыгрузкиНоменклатуры);
	ВыгрузитьДокумент(Объект);
	
	//+malkov #49
	МассивИзготовителей = Новый Массив;
	
	Для Каждого Строка Из Объект.Товары Цикл 
		
		Если ЗначениеЗаполнено(Строка.Изготовитель) Тогда 
			МассивИзготовителей.Добавить(Строка.Изготовитель);
		КонецЕсли;
		
	КонецЦикла;	
	
	ВыгрузитьЭлементыСправочника(МассивИзготовителей, КаталогВыгрузкиИзготовителей);
	///malkov
	
КонецПроцедуры

КаталогВыгрузкиКонтрагентов	= "\\csb1\CSB\EDI\import\10\";//"D:\1c\CSB_System\Adress\";
КаталогВыгрузкиНоменклатуры	= "\\csb1\CSB\EDI\import\12\";//"D:\1c\CSB_System\Artikul\";
КаталогВыгрузкиПоступления	= "\\csb1\CSB\EDI\import\2123\";//"D:\1c\CSB_System\Priemka\";

//+malkov #49
КаталогВыгрузкиИзготовителей = "\\csb1\CSB\EDI\import\10-1\"; //"D:\1c\CSB_System\test_izg\";
//malkov

//тествые каталоги
//КаталогВыгрузкиКонтрагентов	= "D:\1c\CSB_System\Adress\";
//КаталогВыгрузкиНоменклатуры	= "D:\1c\CSB_System\Artikul\";
//КаталогВыгрузкиПоступления	= "D:\1c\CSB_System\Priemka\";
//КаталогВыгрузкиИзготовителей = "D:\1c\CSB_System\test_izg\";



